<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Madani Budget Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF & Excel Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .fab-shadow { box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4); }
        
        /* Nav Styles */
        .nav-item.active { color: #0d9488; }
        .nav-item { color: #94a3b8; transition: color 0.3s; }
        
        /* Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- === MAIN CONTAINER === -->
    <div id="main-container" class="w-full max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <h1 class="text-lg font-bold text-teal-700 flex items-center gap-2">
                <i class="fas fa-wallet"></i> Madani Budget
            </h1>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider">Net Worth</p>
                <h2 class="text-xl font-bold text-slate-800" id="total-balance">₹0</h2>
            </div>
        </header>

        <!-- === 1. HOME VIEW === -->
        <section id="view-home" class="p-4 fade-in block pb-24">
            <!-- Account Cards -->
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 text-center">
                    <div class="text-blue-600 mb-1 text-lg"><i class="fas fa-money-bill-wave"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Cash</p>
                    <p class="text-sm font-bold text-slate-800" id="cash-balance">₹0</p>
                </div>
                <div class="bg-indigo-50 p-3 rounded-2xl border border-indigo-100 text-center">
                    <div class="text-indigo-600 mb-1 text-lg"><i class="fas fa-landmark"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Bank</p>
                    <p class="text-sm font-bold text-slate-800" id="bank-balance">₹0</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-2xl border border-orange-100 text-center relative">
                    <div class="text-orange-500 mb-1 text-lg"><i class="fas fa-hand-holding-usd"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Udhar</p>
                    <p class="text-sm font-bold text-orange-600" id="udhar-balance">₹0</p>
                </div>
            </div>

            <!-- Income/Expense Summary (Clickable) -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Income Card -->
                <div onclick="showSummary('income')" class="cursor-pointer bg-emerald-50 p-4 rounded-2xl border border-emerald-100 flex justify-between items-center transition-transform active:scale-95 hover:bg-emerald-100">
                    <div>
                        <p class="text-[10px] text-emerald-600 font-bold uppercase flex items-center gap-1">Income <i class="fas fa-info-circle text-[8px]"></i></p>
                        <p class="text-lg font-bold text-emerald-700" id="total-income">₹0</p>
                    </div>
                    <div class="bg-emerald-200/50 w-8 h-8 rounded-full flex items-center justify-center text-emerald-700"><i class="fas fa-arrow-down"></i></div>
                </div>
                <!-- Expense Card -->
                <div onclick="showSummary('expense')" class="cursor-pointer bg-rose-50 p-4 rounded-2xl border border-rose-100 flex justify-between items-center transition-transform active:scale-95 hover:bg-rose-100">
                    <div>
                        <p class="text-[10px] text-rose-600 font-bold uppercase flex items-center gap-1">Expense <i class="fas fa-info-circle text-[8px]"></i></p>
                        <p class="text-lg font-bold text-rose-700" id="total-expense">₹0</p>
                    </div>
                    <div class="bg-rose-200/50 w-8 h-8 rounded-full flex items-center justify-center text-rose-700"><i class="fas fa-arrow-up"></i></div>
                </div>
            </div>

            <!-- Analysis Section (Enhanced) -->
            <h3 class="font-bold text-slate-700 text-sm mb-3">Expense Analysis</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-4">
                <div class="flex justify-center mb-6 relative">
                    <div class="h-48 w-48 relative z-10">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <!-- Total Overlay -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Total</p>
                        <p class="text-lg font-bold text-slate-800" id="chart-total-center">₹0</p>
                    </div>
                </div>
                
                <!-- Category Legend with Icons & Percent -->
                <div id="analysis-legend" class="space-y-3">
                    <!-- JS will populate this -->
                </div>
            </div>
        </section>

        <!-- === 2. REPORT VIEW === -->
        <section id="view-report" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Transaction Report</h2>
            
            <div class="flex gap-2 mb-4">
                <button onclick="downloadPDF()" class="flex-1 bg-slate-800 text-white py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-slate-200"><i class="fas fa-file-pdf mr-1"></i> PDF Report</button>
                <button onclick="downloadExcel()" class="flex-1 bg-green-700 text-white py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-green-100"><i class="fas fa-file-excel mr-1"></i> Excel</button>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-2">All History</h3>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                 <ul id="full-list" class="divide-y divide-slate-50"></ul>
            </div>
        </section>

        <!-- === 3. UDHAR VIEW === -->
        <section id="view-udhar" class="p-4 fade-in hidden pb-24">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-800">Udhar Manager</h2>
                <span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold">To Collect</span>
            </div>
            
            <!-- Total Card -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-5 rounded-2xl shadow-lg shadow-orange-200 mb-6 text-white relative overflow-hidden">
                <i class="fas fa-hand-holding-usd absolute -right-4 -bottom-4 text-8xl text-white opacity-20"></i>
                <p class="text-xs text-orange-100 uppercase font-bold tracking-wider mb-1">Total Udhar Market Mein</p>
                <h1 class="text-3xl font-bold" id="udhar-total-display">₹0</h1>
                <p class="text-[10px] text-orange-100 mt-2 opacity-80">Tap 'Wusool' to collect money back.</p>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-3">Active Loans (Logon ne dene hain)</h3>
            <ul id="udhar-list" class="space-y-3"></ul>
            <p id="no-udhar-msg" class="text-center text-slate-400 text-xs py-10 hidden">No active loans.</p>
        </section>

        <!-- === 4. SETTINGS VIEW === -->
        <section id="view-settings" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="exportData()" class="w-full text-left p-4 border-b border-slate-50 hover:bg-slate-50 flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-cloud-download-alt"></i></div>
                    <div>
                        <p class="text-sm font-bold text-slate-700">Backup Data</p>
                        <p class="text-[10px] text-slate-400">Save data to phone</p>
                    </div>
                </button>
                <button onclick="document.getElementById('import-file').click()" class="w-full text-left p-4 border-b border-slate-50 hover:bg-slate-50 flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div>
                        <p class="text-sm font-bold text-slate-700">Restore Data</p>
                        <p class="text-[10px] text-slate-400">Load backup file</p>
                    </div>
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                
                <button onclick="clearAll()" class="w-full text-left p-4 hover:bg-red-50 flex items-center gap-3 text-red-600 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center"><i class="fas fa-trash"></i></div>
                    <div>
                        <p class="text-sm font-bold">Reset App</p>
                        <p class="text-[10px] text-red-400">Delete everything</p>
                    </div>
                </button>
            </div>
            <p class="text-center text-[10px] text-slate-300 mt-8">Madani Budget v3.2 Pro</p>
        </section>
    </div>

    <!-- === ADD MODAL === -->
    <div id="add-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 transition-opacity">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-fade-in-up shadow-2xl" style="max-height: 90vh; overflow-y: auto;">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800">Add Entry</h3>
                <button onclick="toggleModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>

            <div class="space-y-5">
                <!-- Type Toggles -->
                <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onclick="setTxType('expense')" id="btn-expense" class="type-btn py-2 rounded-lg text-xs font-bold transition-all bg-white text-rose-600 shadow-sm">Expense</button>
                    <button onclick="setTxType('income')" id="btn-income" class="type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50">Income</button>
                    <button onclick="setTxType('udhar')" id="btn-udhar" class="type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50">Udhar</button>
                </div>
                <input type="hidden" id="tx-type" value="expense">

                <!-- Amount -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Amount</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold text-lg">₹</span>
                        <input type="number" id="tx-amount" placeholder="0" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all">
                    </div>
                </div>

                <!-- Normal Fields -->
                <div id="normal-fields" class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Category</label>
                        <select id="tx-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                            <!-- JS will fill this -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Wallet (Account)</label>
                        <select id="tx-account" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                            <option value="Cash">Cash</option>
                            <option value="Bank">Bank Account</option>
                        </select>
                    </div>
                </div>

                <!-- Udhar Specific Fields -->
                <div id="udhar-fields" class="hidden space-y-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Kis ko diya? (Name)</label>
                        <input type="text" id="udhar-person" placeholder="e.g. Rahul, Shopkeeper..." class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Mobile Number (WhatsApp)</label>
                        <input type="tel" id="udhar-phone" placeholder="e.g. 919876543210" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Kahan se diya? (Source)</label>
                        <select id="udhar-source" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                            <option value="Cash">Cash se diya (Cash -)</option>
                            <option value="Bank">Bank se diya (Bank -)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Wapas kab ayenge? (Date)</label>
                        <input type="date" id="udhar-return-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                    </div>
                </div>

                <!-- Common Date/Note -->
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Date</label>
                        <input type="date" id="tx-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Note</label>
                        <input type="text" id="tx-note" placeholder="Optional details..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none">
                    </div>
                </div>

                <button onclick="saveTransaction()" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-teal-200 hover:bg-teal-700 transition active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-check"></i> Save Entry
                </button>
            </div>
        </div>
    </div>

    <!-- === SUMMARY MODAL (NEW) === -->
    <div id="summary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="font-bold text-lg text-slate-800" id="summary-title">Summary</h3>
                <button onclick="document.getElementById('summary-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="summary-content" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- === WUSOOL MODAL (Recover Money) === -->
    <div id="wusool-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-1">Money Received?</h3>
            <p class="text-xs text-slate-500 mb-4" id="wusool-msg">Settling udhar for...</p>
            <input type="hidden" id="wusool-id">
            
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deposit To</label>
            <select id="wusool-account" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold mb-4">
                <option value="Cash">Cash (Cash +)</option>
                <option value="Bank">Bank Account (Bank +)</option>
            </select>

            <div class="flex gap-2">
                <button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="flex-1 py-2 text-slate-500 font-bold text-xs bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="confirmWusool()" class="flex-1 py-2 text-white font-bold text-xs bg-green-600 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- === BOTTOM NAVIGATION === -->
    <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 flex justify-between items-end px-4 pb-2 pt-2 z-40 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.05)]" style="left: 50%; transform: translateX(-50%);">
        <button onclick="switchView('home')" class="nav-item active flex flex-col items-center w-14 p-2 gap-1" id="nav-home">
            <i class="fas fa-home text-lg"></i>
            <span class="text-[9px] font-bold">Home</span>
        </button>
        <button onclick="switchView('report')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-report">
            <i class="fas fa-chart-pie text-lg"></i>
            <span class="text-[9px] font-bold">Report</span>
        </button>
        
        <!-- FAB -->
        <div class="relative w-12 flex justify-center z-50">
            <button onclick="toggleModal()" class="absolute -top-12 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl fab-shadow transition-transform active:scale-90 border-[4px] border-slate-50">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <button onclick="switchView('udhar')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-udhar">
            <i class="fas fa-hand-holding-usd text-lg"></i>
            <span class="text-[9px] font-bold">Udhar</span>
        </button>
        <button onclick="switchView('settings')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-settings">
            <i class="fas fa-cog text-lg"></i>
            <span class="text-[9px] font-bold">Settings</span>
        </button>
    </nav>

    <script>
        // --- DATA & SETUP ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        const expenseCats = ["Food", "Rent", "Bills", "Transport", "Shopping", "Medical", "Education", "Charity", "Other"];
        const incomeCats = ["Salary", "Business", "Gift", "Bonus", "Loan Taken", "Other"];
        
        // Icon Map
        const categoryIcons = {
            "Food": "fa-utensils text-orange-500",
            "Rent": "fa-home text-blue-500",
            "Bills": "fa-file-invoice-dollar text-red-500",
            "Transport": "fa-bus text-yellow-500",
            "Shopping": "fa-shopping-bag text-purple-500",
            "Medical": "fa-briefcase-medical text-green-500",
            "Education": "fa-graduation-cap text-indigo-500",
            "Charity": "fa-hand-holding-heart text-pink-500",
            "Other": "fa-shapes text-gray-500"
        };

        const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        window.onload = function() {
            setupDates();
            switchView('home');
            updateUI();
        };

        function setupDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
        }

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
        }

        // --- NAVIGATION ---
        function switchView(view) {
            ['home', 'report', 'udhar', 'settings'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                document.getElementById('nav-'+v).classList.remove('active', 'text-teal-600');
                if(v !== view) document.getElementById('nav-'+v).classList.add('text-slate-300');
            });
            document.getElementById('view-'+view).classList.remove('hidden');
            const nav = document.getElementById('nav-'+view);
            nav.classList.add('active', 'text-teal-600');
            nav.classList.remove('text-slate-300');

            if(view === 'home') { updateChart(); }
            if(view === 'report') { renderFullList(); }
            if(view === 'udhar') renderUdharList();
        }

        function toggleModal() {
            const m = document.getElementById('add-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                setTxType('expense');
                document.getElementById('tx-amount').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('udhar-person').value = '';
                document.getElementById('udhar-phone').value = '';
            }
        }

        // --- SUMMARY MODAL LOGIC ---
        function showSummary(type) {
            const modal = document.getElementById('summary-modal');
            const title = document.getElementById('summary-title');
            const content = document.getElementById('summary-content');
            
            const filtered = transactions.filter(t => t.type === type);
            const total = filtered.reduce((sum, t) => sum + t.amount, 0);
            
            const categories = {};
            filtered.forEach(t => { categories[t.desc] = (categories[t.desc] || 0) + t.amount; });

            title.innerText = type === 'income' ? 'Income Breakdown' : 'Expense Breakdown';
            title.className = `font-bold text-lg ${type === 'income' ? 'text-emerald-700' : 'text-rose-700'}`;
            
            if (filtered.length === 0) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-clipboard-list text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 text-sm">No records found yet.</p></div>';
            } else {
                let html = `
                    <div class="mb-5 text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Total ${type}</p>
                        <h2 class="text-3xl font-bold ${type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${formatter.format(total)}</h2>
                    </div>
                `;
                
                const sortedCats = Object.entries(categories).sort((a,b) => b[1] - a[1]);
                
                html += '<ul class="space-y-3">';
                sortedCats.forEach(([cat, amount]) => {
                    const percent = ((amount / total) * 100).toFixed(1);
                    const barColor = type === 'income' ? 'bg-emerald-500' : 'bg-rose-500';
                    const iconClass = categoryIcons[cat] || "fa-circle text-slate-400";

                    html += `
                        <li>
                            <div class="flex justify-between items-center mb-1 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs"><i class="fas ${iconClass}"></i></div>
                                    <span class="font-bold text-slate-700">${cat}</span>
                                </div>
                                <div class="text-right leading-none">
                                    <span class="font-bold block text-slate-800">${formatter.format(amount)}</span>
                                    <span class="text-[9px] text-slate-400 font-bold">${percent}%</span>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden ml-8 w-[calc(100%-2rem)]">
                                <div class="h-full ${barColor} rounded-full" style="width: ${percent}%"></div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                content.innerHTML = html;
            }

            modal.classList.remove('hidden');
        }

        // --- TRANSACTION TYPE LOGIC ---
        function setTxType(type) {
            document.getElementById('tx-type').value = type;
            const btns = document.querySelectorAll('.type-btn');
            btns.forEach(b => b.className = 'type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50');
            
            const activeBtn = document.getElementById('btn-'+type);
            activeBtn.classList.remove('text-slate-500', 'hover:bg-white/50');
            activeBtn.classList.add('bg-white', 'shadow-sm');

            if(type === 'expense') {
                activeBtn.classList.add('text-rose-600');
                populateCats(expenseCats);
                showUdharFields(false);
            } else if(type === 'income') {
                activeBtn.classList.add('text-emerald-600');
                populateCats(incomeCats);
                showUdharFields(false);
            } else {
                activeBtn.classList.add('text-orange-600');
                showUdharFields(true);
            }
        }

        function showUdharFields(show) {
            if(show) {
                document.getElementById('normal-fields').classList.add('hidden');
                document.getElementById('udhar-fields').classList.remove('hidden');
            } else {
                document.getElementById('normal-fields').classList.remove('hidden');
                document.getElementById('udhar-fields').classList.add('hidden');
            }
        }

        function populateCats(cats) {
            const sel = document.getElementById('tx-category');
            sel.innerHTML = '';
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                sel.appendChild(opt);
            });
        }

        // --- CORE LOGIC ---
        function saveTransaction() {
            const type = document.getElementById('tx-type').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value;
            
            if(!amount || amount <= 0) return alert("Enter valid amount");

            let entry = {
                id: Date.now(),
                date: date,
                amount: amount,
                type: type,
                note: note
            };

            if (type === 'udhar') {
                const person = document.getElementById('udhar-person').value;
                const phone = document.getElementById('udhar-phone').value;
                const source = document.getElementById('udhar-source').value;
                const returnDate = document.getElementById('udhar-return-date').value;
                
                if(!person) return alert("Person name required");
                
                entry.desc = `Loan to ${person}`;
                entry.account = source; 
                entry.person = person;
                entry.phone = phone;
                entry.returnDate = returnDate;
                entry.isUdhar = true;
                entry.status = 'active'; 
            } else {
                entry.desc = document.getElementById('tx-category').value;
                entry.account = document.getElementById('tx-account').value;
                entry.isUdhar = false;
            }

            transactions.push(entry);
            saveData();
            toggleModal();

            if(type === 'udhar' && entry.phone) {
                const cleanPhone = entry.phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                const msg = `Salam%0A${entry.person},%0AAapne ₹${entry.amount} udhaar liye hain / kaam ki rakam hai.%0AWapas karne ki tareekh: ${entry.returnDate || 'Tay nahi hui'}.%0AEntry save kar di gayi hai.`;
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
            }
        }

        function updateUI() {
            let cash = 0, bank = 0, udhar = 0, income = 0, expense = 0;

            transactions.forEach(t => {
                if(t.type === 'income') {
                    income += t.amount;
                    if(t.account === 'Cash') cash += t.amount; else bank += t.amount;
                } 
                else if(t.type === 'expense') {
                    expense += t.amount;
                    if(t.account === 'Cash') cash -= t.amount; else bank -= t.amount;
                }
                else if(t.type === 'udhar' && t.status === 'active') {
                    udhar += t.amount;
                    if(t.account === 'Cash') cash -= t.amount; else bank -= t.amount;
                }
            });

            document.getElementById('total-balance').innerText = formatter.format(cash + bank + udhar);
            document.getElementById('cash-balance').innerText = formatter.format(cash);
            document.getElementById('bank-balance').innerText = formatter.format(bank);
            document.getElementById('udhar-balance').innerText = formatter.format(udhar);
            document.getElementById('udhar-total-display').innerText = formatter.format(udhar);
            document.getElementById('total-income').innerText = formatter.format(income);
            document.getElementById('total-expense').innerText = formatter.format(expense);

            updateChart();
        }

        // --- UDHAR MANAGEMENT ---
        function renderUdharList() {
            const list = document.getElementById('udhar-list');
            list.innerHTML = '';
            const loans = transactions.filter(t => t.type === 'udhar' && t.status === 'active');

            if(loans.length === 0) document.getElementById('no-udhar-msg').classList.remove('hidden');
            else document.getElementById('no-udhar-msg').classList.add('hidden');

            loans.forEach(t => {
                const li = document.createElement('li');
                li.className = "bg-white p-4 rounded-2xl border border-orange-100 shadow-sm relative overflow-hidden";
                li.innerHTML = `
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <div>
                            <h4 class="font-bold text-slate-800">${t.person}</h4>
                            <p class="text-[10px] text-slate-400">Given from: ${t.account}</p>
                        </div>
                        <h3 class="font-bold text-orange-600">${formatter.format(t.amount)}</h3>
                    </div>
                    <div class="flex justify-between items-center relative z-10 mt-2">
                        <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">
                            <i class="fas fa-clock mr-1"></i> Due: ${t.returnDate || 'No Date'}
                        </span>
                        <div class="flex gap-2">
                            ${t.phone ? `<a href="https://wa.me/${t.phone.length===10?'91'+t.phone:t.phone}?text=Reminder: ${t.person}, udhar wapas kab kar rahe ho?" target="_blank" class="bg-green-100 text-green-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-green-200"><i class="fab fa-whatsapp"></i></a>` : ''}
                            <button onclick="openWusool(${t.id})" class="bg-green-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-md shadow-green-100 active:scale-95 transition-transform">
                                Wusool (Recover)
                            </button>
                        </div>
                    </div>
                    <div class="absolute right-0 top-0 w-16 h-full bg-orange-50/50 -skew-x-12 transform translate-x-8"></div>
                `;
                list.appendChild(li);
            });
        }

        function openWusool(id) {
            const t = transactions.find(x => x.id === id);
            document.getElementById('wusool-id').value = id;
            document.getElementById('wusool-msg').innerText = `Recovering ₹${t.amount} from ${t.person}`;
            document.getElementById('wusool-modal').classList.remove('hidden');
        }

        function confirmWusool() {
            const id = parseInt(document.getElementById('wusool-id').value);
            const targetAcc = document.getElementById('wusool-account').value;
            
            const idx = transactions.findIndex(t => t.id === id);
            if(idx > -1) {
                const originalTx = transactions[idx];
                transactions[idx].status = 'settled';
                
                const recoveryEntry = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    amount: originalTx.amount,
                    type: 'income',
                    desc: `Recovery: ${originalTx.person}`,
                    account: targetAcc,
                    note: 'Udhar recovered'
                };
                transactions.push(recoveryEntry);
                saveData();
                document.getElementById('wusool-modal').classList.add('hidden');
                renderUdharList();

                // Calculate Remaining Balance for this Person
                const personName = originalTx.person;
                const remaining = transactions
                    .filter(t => t.type === 'udhar' && t.status === 'active' && t.person === personName)
                    .reduce((sum, t) => sum + t.amount, 0);

                // Send WhatsApp Message if phone exists
                if (originalTx.phone) {
                    const cleanPhone = originalTx.phone.replace(/\D/g, '');
                    const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                    let msg = "";
                    
                    if (remaining > 0) {
                        msg = `Salam%0A${personName},%0AAaj aapki taraf se ₹${originalTx.amount} receive hue.%0ABaaki: ₹${remaining}.%0AShukriya.`;
                    } else {
                        msg = `${personName},%0AAaj aapki taraf se ₹${originalTx.amount} receive hue.%0AShukriya.`;
                    }
                    
                    window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
                }
            }
        }

        // --- REPORTING ---
        function renderFullList() {
            const list = document.getElementById('full-list');
            list.innerHTML = '';
            const sorted = [...transactions].reverse();
            
            sorted.forEach(t => {
                let color = t.type === 'income' ? 'text-emerald-600' : (t.type === 'udhar' ? 'text-orange-500' : 'text-rose-600');
                let sign = t.type === 'income' ? '+' : '-';
                
                const li = document.createElement('li');
                li.className = "p-4 flex justify-between items-center hover:bg-slate-50";
                li.innerHTML = `
                    <div>
                        <div class="font-bold text-xs text-slate-700">${t.desc}</div>
                        <div class="text-[10px] text-slate-400">${t.date} • ${t.type.toUpperCase()}</div>
                    </div>
                    <div class="text-sm font-bold ${color}">${sign}${formatter.format(t.amount)}</div>
                `;
                list.appendChild(li);
            });
        }

        let chartInstance = null;
        function updateChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const legendContainer = document.getElementById('analysis-legend');
            const expenses = {};
            
            // Filter only expenses
            const expenseTx = transactions.filter(t => t.type === 'expense');
            const totalExpense = expenseTx.reduce((sum, t) => sum + t.amount, 0);

            // Group by category
            expenseTx.forEach(t => {
                expenses[t.desc] = (expenses[t.desc] || 0) + t.amount;
            });

            // Update Center Total
            document.getElementById('chart-total-center').innerText = formatter.format(totalExpense);

            // 1. Draw Chart
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenses),
                    datasets: [{
                        data: Object.values(expenses),
                        backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#64748b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%', // Thinner ring
                    plugins: { 
                        legend: { display: false }, // Hide default legend
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed;
                                    const pct = ((val/totalExpense)*100).toFixed(1);
                                    return ` ${context.label}: ${formatter.format(val)} (${pct}%)`;
                                }
                            }
                        }
                    } 
                }
            });

            // 2. Generate Custom Legend
            legendContainer.innerHTML = '';
            if (Object.keys(expenses).length === 0) {
                legendContainer.innerHTML = '<p class="text-center text-xs text-slate-400">No expenses recorded yet.</p>';
                return;
            }

            // Sort by amount
            const sortedCats = Object.entries(expenses).sort((a,b) => b[1] - a[1]);

            sortedCats.forEach(([cat, amount], index) => {
                const percent = ((amount / totalExpense) * 100).toFixed(1);
                const iconClass = categoryIcons[cat] || "fa-circle";
                const colors = ['bg-rose-500', 'bg-blue-500', 'bg-green-500', 'bg-amber-500', 'bg-violet-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-slate-500'];
                const color = colors[index % colors.length]; // Cycle colors to match chart roughly

                const html = `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 shadow-sm border border-slate-100">
                                <i class="fas ${iconClass} text-xs"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-xs">${cat}</p>
                                <div class="w-24 h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                    <div class="h-full ${color}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p>
                            <p class="text-[10px] text-slate-400 font-bold">${percent}%</p>
                        </div>
                    </div>
                `;
                legendContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- EXPORT/PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(13, 148, 136); // Teal Color
            doc.text("Madani Budget Report", 14, 20);
            
            // Subtitle with timestamp
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
            
            // Prepare Data
            const rows = transactions.slice().reverse().map(t => {
                // Extract Time from ID (timestamp)
                const dateObj = new Date(t.id);
                const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return [
                    { content: `${t.date}\n${timeStr}`, styles: { halign: 'center', valign: 'middle' } }, // Date & Time
                    t.desc,             // Category
                    t.note || '-',      // Details
                    t.type.toUpperCase(), // Type
                    t.account,          // Account
                    { content: formatter.format(t.amount).replace('₹', ''), styles: { halign: 'right', fontStyle: 'bold' } } // Amount
                ];
            });

            doc.autoTable({
                head: [['Date & Time', 'Category', 'Details', 'Type', 'Account', 'Amount']],
                body: rows,
                startY: 35,
                theme: 'grid',
                styles: { 
                    fontSize: 8, 
                    cellPadding: 3,
                    lineColor: [220, 220, 220],
                    lineWidth: 0.1,
                    textColor: 50
                },
                headStyles: { 
                    fillColor: [13, 148, 136], 
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Date Col
                    1: { cellWidth: 30, fontStyle: 'bold' }, // Category
                    2: { cellWidth: 'auto' }, // Details (takes remaining space)
                    3: { cellWidth: 20, halign: 'center' }, // Type
                    4: { cellWidth: 25, halign: 'center' }, // Account
                    5: { cellWidth: 25 }  // Amount
                },
                // Custom hook to make Time smaller (optional visual tweak via textColor if needed)
                didParseCell: function(data) {
                    if (data.column.index === 0 && data.section === 'body') {
                        // Just rely on newline for "neeche"
                    }
                }
            });
            doc.save('Madani_Budget_Report.pdf');
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(transactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");
            XLSX.writeFile(wb, "budget_data.xlsx");
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
            const a = document.createElement('a');
            a.href = dataStr; a.download = "backup.json"; a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                transactions = JSON.parse(e.target.result);
                saveData();
                alert("Data Restored!");
            };
            reader.readAsText(input.files[0]);
        }
        
        function clearAll() {
            if(confirm("Delete All Data?")) {
                transactions = [];
                saveData();
            }
        }
    </script>
</body>
</html>
