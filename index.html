<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Madani Budget Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF & Excel Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .fab-shadow { box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4); }
        
        /* Nav Styles */
        .nav-item.active { color: #0d9488; }
        .nav-item { color: #94a3b8; transition: color 0.3s; }
        
        /* Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- === MAIN CONTAINER === -->
    <div id="main-container" class="w-full max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <h1 class="text-lg font-bold text-teal-700 flex items-center gap-2">
                <i class="fas fa-wallet"></i> Madani Budget
            </h1>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider">Net Worth</p>
                <h2 class="text-xl font-bold text-slate-800" id="total-balance">₹0</h2>
            </div>
        </header>

        <!-- === 1. HOME VIEW === -->
        <section id="view-home" class="p-4 fade-in block pb-24">
            <!-- Account Cards -->
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 text-center">
                    <div class="text-blue-600 mb-1 text-lg"><i class="fas fa-money-bill-wave"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Cash</p>
                    <p class="text-sm font-bold text-slate-800" id="cash-balance">₹0</p>
                </div>
                <div class="bg-indigo-50 p-3 rounded-2xl border border-indigo-100 text-center">
                    <div class="text-indigo-600 mb-1 text-lg"><i class="fas fa-landmark"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Bank</p>
                    <p class="text-sm font-bold text-slate-800" id="bank-balance">₹0</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-2xl border border-orange-100 text-center relative">
                    <div class="text-orange-500 mb-1 text-lg"><i class="fas fa-hand-holding-usd"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Udhar (Pending)</p>
                    <p class="text-sm font-bold text-orange-600" id="udhar-balance">₹0</p>
                </div>
            </div>

            <!-- Income/Expense Summary (Clickable) -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Income Card -->
                <div onclick="showSummary('income')" class="cursor-pointer bg-emerald-50 p-4 rounded-2xl border border-emerald-100 flex justify-between items-center transition-transform active:scale-95 hover:bg-emerald-100">
                    <div>
                        <p class="text-[10px] text-emerald-600 font-bold uppercase flex items-center gap-1">Income <i class="fas fa-info-circle text-[8px]"></i></p>
                        <p class="text-lg font-bold text-emerald-700" id="total-income">₹0</p>
                    </div>
                    <div class="bg-emerald-200/50 w-8 h-8 rounded-full flex items-center justify-center text-emerald-700"><i class="fas fa-arrow-down"></i></div>
                </div>
                <!-- Expense Card -->
                <div onclick="showSummary('expense')" class="cursor-pointer bg-rose-50 p-4 rounded-2xl border border-rose-100 flex justify-between items-center transition-transform active:scale-95 hover:bg-rose-100">
                    <div>
                        <p class="text-[10px] text-rose-600 font-bold uppercase flex items-center gap-1">Expense <i class="fas fa-info-circle text-[8px]"></i></p>
                        <p class="text-lg font-bold text-rose-700" id="total-expense">₹0</p>
                    </div>
                    <div class="bg-rose-200/50 w-8 h-8 rounded-full flex items-center justify-center text-rose-700"><i class="fas fa-arrow-up"></i></div>
                </div>
            </div>

            <!-- Analysis Section (Enhanced) -->
            <h3 class="font-bold text-slate-700 text-sm mb-3">Expense Analysis</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-4">
                <div class="flex justify-center mb-6 relative">
                    <div class="h-48 w-48 relative z-10">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <!-- Total Overlay -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Total</p>
                        <p class="text-lg font-bold text-slate-800" id="chart-total-center">₹0</p>
                    </div>
                </div>
                
                <!-- Category Legend with Icons & Percent -->
                <div id="analysis-legend" class="space-y-3">
                    <!-- JS will populate this -->
                </div>
            </div>
        </section>

        <!-- === 2. REPORT VIEW === -->
        <section id="view-report" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Transaction Report</h2>
            
            <div class="flex gap-2 mb-4">
                <button onclick="downloadPDF()" class="flex-1 bg-slate-800 text-white py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-slate-200"><i class="fas fa-file-pdf mr-1"></i> PDF Report</button>
                <button onclick="downloadExcel()" class="flex-1 bg-green-700 text-white py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-green-100"><i class="fas fa-file-excel mr-1"></i> Excel</button>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-2">All History</h3>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                 <ul id="full-list" class="divide-y divide-slate-50"></ul>
            </div>
        </section>

        <!-- === 3. UDHAR VIEW === -->
        <section id="view-udhar" class="p-4 fade-in hidden pb-24">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-800">Udhar Manager</h2>
                <span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold">To Collect</span>
            </div>
            
            <!-- Total Card -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-5 rounded-2xl shadow-lg shadow-orange-200 mb-6 text-white relative overflow-hidden">
                <i class="fas fa-hand-holding-usd absolute -right-4 -bottom-4 text-8xl text-white opacity-20"></i>
                <p class="text-xs text-orange-100 uppercase font-bold tracking-wider mb-1">Total Udhar Market Mein</p>
                <h1 class="text-3xl font-bold" id="udhar-total-display">₹0</h1>
                <p class="text-[10px] text-orange-100 mt-2 opacity-80">Manage loans & recoveries.</p>
            </div>

            <!-- NEW ENTRY BUTTON -->
            <div class="mb-4">
                <button onclick="openNewUdharModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-slate-200 flex items-center justify-center gap-2 transition-all active:scale-95 border border-slate-700">
                    <div class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-plus text-xs"></i></div>
                    <span>Naya Udhar (New Contact)</span>
                </button>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-3">Logon pe Baqaya (Active List)</h3>
            
            <!-- UDHAR LIST -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <ul id="udhar-list" class="divide-y divide-slate-50"></ul>
            </div>
            
            <p id="no-udhar-msg" class="text-center text-slate-400 text-xs py-10 hidden">No active loans.</p>
        </section>

        <!-- === 4. SETTINGS VIEW === -->
        <section id="view-settings" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="exportData()" class="w-full text-left p-4 border-b border-slate-50 hover:bg-slate-50 flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-cloud-download-alt"></i></div>
                    <div>
                        <p class="text-sm font-bold text-slate-700">Backup Data</p>
                        <p class="text-[10px] text-slate-400">Save data to phone</p>
                    </div>
                </button>
                <button onclick="document.getElementById('import-file').click()" class="w-full text-left p-4 border-b border-slate-50 hover:bg-slate-50 flex items-center gap-3 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div>
                        <p class="text-sm font-bold text-slate-700">Restore Data</p>
                        <p class="text-[10px] text-slate-400">Load backup file</p>
                    </div>
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                
                <button onclick="clearAll()" class="w-full text-left p-4 hover:bg-red-50 flex items-center gap-3 text-red-600 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center"><i class="fas fa-trash"></i></div>
                    <div>
                        <p class="text-sm font-bold">Reset App</p>
                        <p class="text-[10px] text-red-400">Delete everything</p>
                    </div>
                </button>
            </div>
            <p class="text-center text-[10px] text-slate-300 mt-8">Madani Budget v3.8 Pro</p>
        </section>
    </div>

    <!-- === ADD MODAL (MAIN) === -->
    <div id="add-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 transition-opacity">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-fade-in-up shadow-2xl" style="max-height: 90vh; overflow-y: auto;">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800" id="add-modal-title">Add Entry</h3>
                <button onclick="toggleModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>

            <div class="space-y-5">
                <!-- Type Toggles -->
                <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onclick="setTxType('expense')" id="btn-expense" class="type-btn py-2 rounded-lg text-xs font-bold transition-all bg-white text-rose-600 shadow-sm">Expense</button>
                    <button onclick="setTxType('income')" id="btn-income" class="type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50">Income</button>
                    <button onclick="setTxType('udhar')" id="btn-udhar" class="type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50">Udhar</button>
                </div>
                <input type="hidden" id="tx-type" value="expense">

                <!-- Amount -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Amount</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold text-lg">₹</span>
                        <input type="number" id="tx-amount" placeholder="0" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all">
                    </div>
                </div>

                <!-- Normal Fields -->
                <div id="normal-fields" class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Category</label>
                        <select id="tx-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                            <!-- JS will fill this -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Wallet (Account)</label>
                        <select id="tx-account" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                            <option value="Cash">Cash</option>
                            <option value="Bank">Bank Account</option>
                        </select>
                    </div>
                </div>

                <!-- Udhar Specific Fields (Updated) -->
                <div id="udhar-fields" class="hidden space-y-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Kis ko diya? (Name)</label>
                        <div class="relative">
                            <input type="text" id="udhar-person" list="udhar-names-list" placeholder="Select or Type Name..." class="w-full p-3 pr-10 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                            <button onclick="pickContact()" class="absolute right-2 top-2.5 text-teal-600 w-8 h-8 flex items-center justify-center hover:bg-teal-50 rounded-full transition-colors" title="Pick from Phone/App">
                                <i class="fas fa-address-book text-lg"></i>
                            </button>
                        </div>
                        <datalist id="udhar-names-list">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Mobile Number (WhatsApp)</label>
                        <input type="tel" id="udhar-phone" placeholder="e.g. 919876543210" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Kahan se diya? (Source)</label>
                        <select id="udhar-source" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                            <option value="Cash">Cash se diya (Cash -)</option>
                            <option value="Bank">Bank se diya (Bank -)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-orange-700 uppercase mb-1">Wapas kab ayenge? (Date)</label>
                        <input type="date" id="udhar-return-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500">
                    </div>
                </div>

                <!-- Common Date/Note -->
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Date</label>
                        <input type="date" id="tx-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Note</label>
                        <input type="text" id="tx-note" placeholder="Optional details..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none">
                    </div>
                </div>

                <button onclick="saveTransaction()" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-teal-200 hover:bg-teal-700 transition active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-check"></i> <span id="save-btn-text">Save Entry</span>
                </button>
            </div>
        </div>
    </div>

    <!-- === EXISTING CONTACTS SELECTOR MODAL === -->
    <div id="contacts-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                <h3 class="font-bold text-slate-800">Select Contact</h3>
                <button onclick="document.getElementById('contacts-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="contacts-list-content" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- === SUMMARY MODAL (NEW) === -->
    <div id="summary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="font-bold text-lg text-slate-800" id="summary-title">Summary</h3>
                <button onclick="document.getElementById('summary-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="summary-content" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- === WUSOOL MODAL (Recover Money) === -->
    <div id="wusool-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-1">Money Received?</h3>
            <p class="text-xs text-slate-500 mb-4" id="wusool-msg">Settling udhar for...</p>
            <input type="hidden" id="wusool-person-name">
            
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Received Amount (₹)</label>
            <input type="number" id="wusool-amount" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-lg font-bold text-slate-800 mb-3 focus:outline-none focus:border-teal-500">

            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deposit To</label>
            <select id="wusool-account" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold mb-4">
                <option value="Cash">Cash (Cash +)</option>
                <option value="Bank">Bank Account (Bank +)</option>
            </select>

            <div class="flex gap-2">
                <button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="flex-1 py-2 text-slate-500 font-bold text-xs bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="confirmWusool()" class="flex-1 py-2 text-white font-bold text-xs bg-green-600 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- === PERSON ACTION & HISTORY MODAL === -->
    <div id="person-history-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up" style="max-height: 85vh;">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <div>
                    <h3 class="font-bold text-lg text-slate-800" id="ph-name">Person Name</h3>
                    <p class="text-[10px] text-slate-400">Manage Loan & History</p>
                </div>
                <button onclick="document.getElementById('person-history-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button id="btn-give-more" class="bg-orange-50 hover:bg-orange-100 text-orange-700 py-3 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-colors border border-orange-100">
                    <i class="fas fa-minus-circle text-lg"></i> Aur Udhar Diya
                </button>
                <button id="btn-receive-money" class="bg-green-50 hover:bg-green-100 text-green-700 py-3 rounded-xl text-xs font-bold flex flex-col items-center gap-1 transition-colors border border-green-100">
                    <i class="fas fa-plus-circle text-lg"></i> Wusool (Receive)
                </button>
            </div>

            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Transaction History</h4>
            <div id="ph-content" class="space-y-3 overflow-y-auto no-scrollbar" style="max-height: 40vh;">
                <!-- History items -->
            </div>
        </div>
    </div>

    <!-- === BOTTOM NAVIGATION === -->
    <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 flex justify-between items-end px-4 pb-2 pt-2 z-40 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.05)]" style="left: 50%; transform: translateX(-50%);">
        <button onclick="switchView('home')" class="nav-item active flex flex-col items-center w-14 p-2 gap-1" id="nav-home">
            <i class="fas fa-home text-lg"></i>
            <span class="text-[9px] font-bold">Home</span>
        </button>
        <button onclick="switchView('report')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-report">
            <i class="fas fa-chart-pie text-lg"></i>
            <span class="text-[9px] font-bold">Report</span>
        </button>
        
        <!-- FAB -->
        <div class="relative w-12 flex justify-center z-50">
            <button onclick="toggleModal()" class="absolute -top-12 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl fab-shadow transition-transform active:scale-90 border-[4px] border-slate-50">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <button onclick="switchView('udhar')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-udhar">
            <i class="fas fa-hand-holding-usd text-lg"></i>
            <span class="text-[9px] font-bold">Udhar</span>
        </button>
        <button onclick="switchView('settings')" class="nav-item flex flex-col items-center w-14 p-2 gap-1" id="nav-settings">
            <i class="fas fa-cog text-lg"></i>
            <span class="text-[9px] font-bold">Settings</span>
        </button>
    </nav>

    <script>
        // --- DATA & SETUP ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        // Global var to track editing
        let editingTransactionId = null;

        const expenseCats = ["Food", "Rent", "Bills", "Transport", "Shopping", "Medical", "Education", "Charity", "Other"];
        const incomeCats = ["Salary", "Business", "Gift", "Bonus", "Loan Taken", "Other"];
        
        // Icon Map
        const categoryIcons = {
            "Food": "fa-utensils text-orange-500",
            "Rent": "fa-home text-blue-500",
            "Bills": "fa-file-invoice-dollar text-red-500",
            "Transport": "fa-bus text-yellow-500",
            "Shopping": "fa-shopping-bag text-purple-500",
            "Medical": "fa-briefcase-medical text-green-500",
            "Education": "fa-graduation-cap text-indigo-500",
            "Charity": "fa-hand-holding-heart text-pink-500",
            "Other": "fa-shapes text-gray-500"
        };

        const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        window.onload = function() {
            setupDates();
            switchView('home');
            updateUI();
        };

        function setupDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
        }

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
        }

        // --- NAVIGATION ---
        function switchView(view) {
            ['home', 'report', 'udhar', 'settings'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                document.getElementById('nav-'+v).classList.remove('active', 'text-teal-600');
                if(v !== view) document.getElementById('nav-'+v).classList.add('text-slate-300');
            });
            document.getElementById('view-'+view).classList.remove('hidden');
            const nav = document.getElementById('nav-'+view);
            nav.classList.add('active', 'text-teal-600');
            nav.classList.remove('text-slate-300');

            if(view === 'home') { updateChart(); }
            if(view === 'report') { renderFullList(); }
            if(view === 'udhar') renderUdharList();
        }

        function toggleModal(typeToSet) {
            const m = document.getElementById('add-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                // If opening, reset everything
                editingTransactionId = null;
                document.getElementById('add-modal-title').innerText = "Add Entry";
                document.getElementById('save-btn-text').innerText = "Save Entry";
                
                if (typeToSet) {
                    setTxType(typeToSet);
                } else {
                    setTxType('expense');
                }
                document.getElementById('tx-amount').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('udhar-person').value = '';
                document.getElementById('udhar-phone').value = '';
                
                // Populate Datalist
                updateDatalist();
                
                // Clear validation
                const personInput = document.getElementById('udhar-person');
                personInput.onchange = function() {
                    const existing = transactions.find(t => t.person === this.value && t.phone);
                    if(existing) document.getElementById('udhar-phone').value = existing.phone;
                };
            }
        }

        function openNewUdharModal() {
            const m = document.getElementById('add-modal');
            m.classList.remove('hidden');
            
            editingTransactionId = null;
            document.getElementById('add-modal-title').innerText = "Add Entry";
            document.getElementById('save-btn-text').innerText = "Save Entry";

            setTxType('udhar');
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
            document.getElementById('udhar-person').value = '';
            document.getElementById('udhar-phone').value = '';
            updateDatalist();
        }

        function updateDatalist() {
            const names = [...new Set(transactions.filter(t => t.type === 'udhar').map(t => t.person))];
            const datalist = document.getElementById('udhar-names-list');
            datalist.innerHTML = '';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
        }

        // --- CONTACT PICKER LOGIC ---
        async function pickContact() {
            // 1. Try Native API
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const opts = { multiple: false };
                    const contacts = await navigator.contacts.select(props, opts);
                    if (contacts.length) {
                        const contact = contacts[0];
                        document.getElementById('udhar-person').value = contact.name[0];
                        if (contact.tel && contact.tel.length) {
                            document.getElementById('udhar-phone').value = contact.tel[0].replace(/\D/g, ''); 
                        }
                    }
                    return;
                } catch (ex) {
                    // Fallback to app contacts
                }
            }
            
            // 2. Fallback: Show App Contacts List
            showAppContactList();
        }

        function showAppContactList() {
            const names = [...new Set(transactions.filter(t => t.type === 'udhar').map(t => t.person))];
            const listDiv = document.getElementById('contacts-list-content');
            listDiv.innerHTML = '';
            
            if(names.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-xs text-slate-400">No contacts saved yet.</p>';
            } else {
                names.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 bg-slate-50 hover:bg-slate-100 rounded-lg text-sm font-bold text-slate-700 flex items-center gap-3";
                    btn.innerHTML = `<div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-xs">${name.charAt(0)}</div> ${name}`;
                    btn.onclick = () => {
                        document.getElementById('udhar-person').value = name;
                        // Auto-fill phone
                        const existing = transactions.find(t => t.person === name && t.phone);
                        if(existing) document.getElementById('udhar-phone').value = existing.phone;
                        
                        document.getElementById('contacts-modal').classList.add('hidden');
                    };
                    listDiv.appendChild(btn);
                });
            }
            document.getElementById('contacts-modal').classList.remove('hidden');
        }

        // --- TIME AGO UTIL ---
        function timeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays <= 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            return `${diffDays} din pehle`;
        }

        // --- SUMMARY MODAL LOGIC ---
        function showSummary(type) {
            const modal = document.getElementById('summary-modal');
            const title = document.getElementById('summary-title');
            const content = document.getElementById('summary-content');
            
            const filtered = transactions.filter(t => t.type === type);
            const total = filtered.reduce((sum, t) => sum + t.amount, 0);
            
            const categories = {};
            filtered.forEach(t => { categories[t.desc] = (categories[t.desc] || 0) + t.amount; });

            title.innerText = type === 'income' ? 'Income Breakdown' : 'Expense Breakdown';
            title.className = `font-bold text-lg ${type === 'income' ? 'text-emerald-700' : 'text-rose-700'}`;
            
            if (filtered.length === 0) {
                content.innerHTML = '<div class="text-center py-8"><i class="fas fa-clipboard-list text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 text-sm">No records found yet.</p></div>';
            } else {
                let html = `
                    <div class="mb-5 text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Total ${type}</p>
                        <h2 class="text-3xl font-bold ${type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${formatter.format(total)}</h2>
                    </div>
                `;
                
                const sortedCats = Object.entries(categories).sort((a,b) => b[1] - a[1]);
                
                html += '<ul class="space-y-3">';
                sortedCats.forEach(([cat, amount]) => {
                    const percent = ((amount / total) * 100).toFixed(1);
                    const barColor = type === 'income' ? 'bg-emerald-500' : 'bg-rose-500';
                    const iconClass = categoryIcons[cat] || "fa-circle text-slate-400";

                    html += `
                        <li>
                            <div class="flex justify-between items-center mb-1 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs"><i class="fas ${iconClass}"></i></div>
                                    <span class="font-bold text-slate-700">${cat}</span>
                                </div>
                                <div class="text-right leading-none">
                                    <span class="font-bold block text-slate-800">${formatter.format(amount)}</span>
                                    <span class="text-[9px] text-slate-400 font-bold">${percent}%</span>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden ml-8 w-[calc(100%-2rem)]">
                                <div class="h-full ${barColor} rounded-full" style="width: ${percent}%"></div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                content.innerHTML = html;
            }

            modal.classList.remove('hidden');
        }

        // --- TRANSACTION TYPE LOGIC ---
        function setTxType(type) {
            document.getElementById('tx-type').value = type;
            const btns = document.querySelectorAll('.type-btn');
            btns.forEach(b => b.className = 'type-btn py-2 rounded-lg text-xs font-bold text-slate-500 transition-all hover:bg-white/50');
            
            const activeBtn = document.getElementById('btn-'+type);
            activeBtn.classList.remove('text-slate-500', 'hover:bg-white/50');
            activeBtn.classList.add('bg-white', 'shadow-sm');

            if(type === 'expense') {
                activeBtn.classList.add('text-rose-600');
                populateCats(expenseCats);
                showUdharFields(false);
            } else if(type === 'income') {
                activeBtn.classList.add('text-emerald-600');
                populateCats(incomeCats);
                showUdharFields(false);
            } else {
                activeBtn.classList.add('text-orange-600');
                showUdharFields(true);
            }
        }

        function showUdharFields(show) {
            if(show) {
                document.getElementById('normal-fields').classList.add('hidden');
                document.getElementById('udhar-fields').classList.remove('hidden');
            } else {
                document.getElementById('normal-fields').classList.remove('hidden');
                document.getElementById('udhar-fields').classList.add('hidden');
            }
        }

        function populateCats(cats) {
            const sel = document.getElementById('tx-category');
            sel.innerHTML = '';
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                sel.appendChild(opt);
            });
        }

        // --- CORE LOGIC ---
        function saveTransaction() {
            const type = document.getElementById('tx-type').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value;
            
            if(!amount || amount <= 0) return alert("Enter valid amount");

            // IF EDITING
            if (editingTransactionId) {
                const idx = transactions.findIndex(t => t.id === editingTransactionId);
                if (idx !== -1) {
                    transactions[idx].amount = amount;
                    transactions[idx].date = date;
                    transactions[idx].note = note;
                    transactions[idx].type = type;
                    
                    if (type === 'udhar') {
                        transactions[idx].person = document.getElementById('udhar-person').value;
                        transactions[idx].phone = document.getElementById('udhar-phone').value;
                        transactions[idx].account = document.getElementById('udhar-source').value;
                        transactions[idx].returnDate = document.getElementById('udhar-return-date').value;
                        transactions[idx].desc = `Loan to ${transactions[idx].person}`;
                    } else {
                        transactions[idx].desc = document.getElementById('tx-category').value;
                        transactions[idx].account = document.getElementById('tx-account').value;
                    }
                    
                    saveData();
                    toggleModal(); // closes modal & resets ID
                    
                    // If we were in history view, refresh it
                    const phModal = document.getElementById('person-history-modal');
                    if (!phModal.classList.contains('hidden')) {
                        const name = document.getElementById('ph-name').innerText;
                        openPersonDetails(name);
                    }
                    return;
                }
            }

            // IF NEW
            let entry = {
                id: Date.now(),
                date: date,
                amount: amount,
                type: type,
                note: note
            };

            if (type === 'udhar') {
                const person = document.getElementById('udhar-person').value;
                const phone = document.getElementById('udhar-phone').value;
                const source = document.getElementById('udhar-source').value;
                const returnDate = document.getElementById('udhar-return-date').value;
                
                if(!person) return alert("Person name required");
                
                entry.desc = `Loan to ${person}`;
                entry.account = source; 
                entry.person = person;
                entry.phone = phone;
                entry.returnDate = returnDate;
                entry.isUdhar = true;
                entry.status = 'active'; 
            } else {
                entry.desc = document.getElementById('tx-category').value;
                entry.account = document.getElementById('tx-account').value;
                entry.isUdhar = false;
            }

            transactions.push(entry);
            saveData();
            toggleModal();

            if(type === 'udhar' && entry.phone) {
                const cleanPhone = entry.phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                const msg = `Salam%0A${entry.person},%0AAapne ₹${entry.amount} udhaar liye hain / kaam ki rakam hai.%0AWapas karne ki tareekh: ${entry.returnDate || 'Tay nahi hui'}.%0AEntry save kar di gayi hai.`;
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
            }
        }

        // --- NEW EDIT & DELETE FUNCTIONS ---
        function deleteTransaction(id) {
            if(!confirm("Are you sure you want to delete this entry?")) return;
            
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            updateUI();
            
            // Refresh Person History Modal if open
            const phModal = document.getElementById('person-history-modal');
            if (!phModal.classList.contains('hidden')) {
                const name = document.getElementById('ph-name').innerText;
                openPersonDetails(name);
                // Also refresh main list
                renderUdharList();
            }
        }

        function editTransaction(id) {
            const t = transactions.find(tx => tx.id === id);
            if (!t) return;

            editingTransactionId = id;
            
            // Hide History Modal temporarily
            document.getElementById('person-history-modal').classList.add('hidden');
            
            // Open Add Modal
            const m = document.getElementById('add-modal');
            m.classList.remove('hidden');
            
            document.getElementById('add-modal-title').innerText = "Edit Entry";
            document.getElementById('save-btn-text').innerText = "Update Entry";

            // Set Type
            setTxType(t.type);
            
            // Fill Fields
            document.getElementById('tx-amount').value = t.amount;
            document.getElementById('tx-date').value = t.date;
            document.getElementById('tx-note').value = t.note || '';

            if (t.type === 'udhar') {
                document.getElementById('udhar-person').value = t.person;
                document.getElementById('udhar-phone').value = t.phone || '';
                document.getElementById('udhar-source').value = t.account;
                document.getElementById('udhar-return-date').value = t.returnDate || '';
            } else {
                // If it's income/expense
                document.getElementById('tx-category').value = t.desc;
                document.getElementById('tx-account').value = t.account;
            }
        }

        function giveMoreUdhar(name) {
            document.getElementById('person-history-modal').classList.add('hidden');
            
            const m = document.getElementById('add-modal');
            m.classList.remove('hidden');
            
            // Ensure fresh state
            editingTransactionId = null;
            document.getElementById('add-modal-title').innerText = "Add Entry";
            document.getElementById('save-btn-text').innerText = "Save Entry";
            
            setTxType('udhar');
            document.getElementById('udhar-person').value = name;
            
            // Find existing phone number
            const existing = transactions.find(t => t.person === name && t.phone);
            if(existing) document.getElementById('udhar-phone').value = existing.phone;
            
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
        }

        function updateUI() {
            let cash = 0, bank = 0, udhar = 0, income = 0, expense = 0;

            transactions.forEach(t => {
                if(t.type === 'income') {
                    income += t.amount;
                    if(t.account === 'Cash') cash += t.amount; else bank += t.amount;
                } 
                else if(t.type === 'expense') {
                    expense += t.amount;
                    if(t.account === 'Cash') cash -= t.amount; else bank -= t.amount;
                }
                else if(t.type === 'udhar' && t.status === 'active') {
                    const paid = t.repaid || 0;
                    const rem = t.amount - paid;
                    udhar += rem;
                    if(t.account === 'Cash') cash -= t.amount; else bank -= t.amount;
                }
            });

            document.getElementById('total-balance').innerText = formatter.format(cash + bank + udhar);
            document.getElementById('cash-balance').innerText = formatter.format(cash);
            document.getElementById('bank-balance').innerText = formatter.format(bank);
            document.getElementById('udhar-balance').innerText = formatter.format(udhar);
            document.getElementById('udhar-total-display').innerText = formatter.format(udhar);
            document.getElementById('total-income').innerText = formatter.format(income);
            document.getElementById('total-expense').innerText = formatter.format(expense);

            updateChart();
        }

        // --- UDHAR MANAGEMENT ---
        function renderUdharList() {
            const list = document.getElementById('udhar-list');
            list.innerHTML = '';
            
            // Group by Person
            const people = {};
            
            transactions.forEach(t => {
                if(t.type === 'udhar' && t.status === 'active') {
                    if(!people[t.person]) {
                        people[t.person] = {
                            name: t.person,
                            total: 0,
                            repaid: 0,
                            lastTxDate: t.date,
                            phone: t.phone
                        };
                    }
                    people[t.person].total += t.amount;
                    people[t.person].repaid += (t.repaid || 0);
                    // Update last tx date if this one is newer
                    if(new Date(t.date) > new Date(people[t.person].lastTxDate)) {
                        people[t.person].lastTxDate = t.date;
                    }
                }
            });

            const activePeople = Object.values(people).filter(p => (p.total - p.repaid) > 0.1);

            if(activePeople.length === 0) document.getElementById('no-udhar-msg').classList.remove('hidden');
            else document.getElementById('no-udhar-msg').classList.add('hidden');

            activePeople.forEach(p => {
                const remaining = p.total - p.repaid;
                const initial = p.name.charAt(0).toUpperCase();
                const li = document.createElement('li');
                
                // Contact List Style
                li.onclick = () => openPersonDetails(p.name);
                li.className = "bg-white p-4 flex items-center justify-between hover:bg-slate-50 transition-colors cursor-pointer group";
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <!-- Avatar -->
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xl shadow-sm border border-slate-200 group-hover:bg-teal-50 group-hover:text-teal-600 transition-colors">
                            ${initial}
                        </div>
                        <!-- Name & Time -->
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm leading-tight mb-0.5 group-hover:text-teal-700 transition-colors">${p.name}</h4>
                            <p class="text-[11px] text-slate-400 font-medium">${timeAgo(p.lastTxDate)}</p>
                        </div>
                    </div>
                    <!-- Amount -->
                    <div class="text-right">
                        <span class="font-bold text-emerald-600 text-base">${formatter.format(remaining)}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function openPersonDetails(name) {
            const modal = document.getElementById('person-history-modal');
            document.getElementById('ph-name').innerText = name;
            modal.classList.remove('hidden'); // Show modal first
            
            // Setup buttons
            document.getElementById('btn-give-more').onclick = () => giveMoreUdhar(name);
            document.getElementById('btn-receive-money').onclick = () => openWusoolForPerson(name);

            const content = document.getElementById('ph-content');
            content.innerHTML = '';

            const related = transactions.filter(t => 
                (t.type === 'udhar' && t.person === name) || 
                (t.type === 'income' && t.desc === `Recovery: ${name}`)
            ).sort((a,b) => b.id - a.id);

            if(related.length === 0) {
                content.innerHTML = '<p class="text-center text-xs text-slate-400">No records found.</p>';
            } else {
                related.forEach(t => {
                    let isRecovery = t.type === 'income';
                    let color = isRecovery ? 'text-green-600' : 'text-orange-600';
                    let icon = isRecovery ? 'fa-arrow-down' : 'fa-arrow-up';
                    let label = isRecovery ? 'Received' : 'Given';
                    let subtext = isRecovery ? t.account : `Due: ${t.returnDate || 'N/A'}`;

                    content.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${isRecovery ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-500'} flex items-center justify-center text-xs">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-xs text-slate-700">${label}</p>
                                    <p class="text-[10px] text-slate-400">${t.date} • ${subtext}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-sm ${color} block">${formatter.format(t.amount)}</span>
                                <div class="flex gap-2 justify-end mt-1">
                                    <button onclick="editTransaction(${t.id})" class="text-slate-400 hover:text-blue-500 text-[10px]"><i class="fas fa-pencil-alt"></i></button>
                                    <button onclick="deleteTransaction(${t.id})" class="text-slate-400 hover:text-red-500 text-[10px]"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        function openWusoolForPerson(name) {
            document.getElementById('person-history-modal').classList.add('hidden');
            // Calculate total pending
            const personLoans = transactions.filter(tx => tx.type === 'udhar' && tx.status === 'active' && tx.person === name);
            const totalPending = personLoans.reduce((sum, tx) => sum + (tx.amount - (tx.repaid || 0)), 0);

            if(totalPending <= 0) return alert("No pending balance.");

            document.getElementById('wusool-person-name').value = name;
            document.getElementById('wusool-msg').innerText = `Total Pending for ${name}: ${formatter.format(totalPending)}`;
            document.getElementById('wusool-amount').value = '';
            
            document.getElementById('wusool-modal').classList.remove('hidden');
        }

        function confirmWusool() {
            const person = document.getElementById('wusool-person-name').value;
            const receivedAmount = parseFloat(document.getElementById('wusool-amount').value);
            const targetAcc = document.getElementById('wusool-account').value;

            if (!receivedAmount || receivedAmount <= 0) return alert("Please enter valid amount");

            // Get all active loans for this person, sorted by date/id (Oldest first)
            let personLoans = transactions.filter(tx => tx.type === 'udhar' && tx.status === 'active' && tx.person === person);
            personLoans.sort((a, b) => a.id - b.id);

            let remainingToAllocate = receivedAmount;
            
            for (let tx of personLoans) {
                if (remainingToAllocate <= 0) break;

                const pendingOnTx = tx.amount - (tx.repaid || 0);
                const allocation = Math.min(pendingOnTx, remainingToAllocate);

                tx.repaid = (tx.repaid || 0) + allocation;
                remainingToAllocate -= allocation;

                if (tx.amount - tx.repaid <= 0.1) { // float tolerance
                    tx.status = 'settled';
                }
            }

            // Create Income Entry
            const recoveryEntry = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                amount: receivedAmount,
                type: 'income',
                desc: `Recovery: ${person}`,
                account: targetAcc,
                note: `Udhar recovered (Bulk Payment)`
            };
            transactions.push(recoveryEntry);
            
            saveData();
            document.getElementById('wusool-modal').classList.add('hidden');
            renderUdharList();

            // WhatsApp Msg (Total Remaining Calculation)
            const allActive = transactions.filter(tx => tx.type === 'udhar' && tx.status === 'active' && tx.person === person);
            const totalRemaining = allActive.reduce((sum, tx) => sum + (tx.amount - (tx.repaid || 0)), 0);
            
            // Find phone number from any transaction of this person
            const lastTx = transactions.slice().reverse().find(tx => tx.person === person && tx.phone);
            
            if (lastTx && lastTx.phone) {
                const cleanPhone = lastTx.phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                let msg = "";
                
                if (totalRemaining > 0) {
                    msg = `Salam%0A${person},%0AAaj aapki taraf se ₹${receivedAmount} receive hue.%0ABaaki: ₹${totalRemaining}.%0AShukriya.`;
                } else {
                    msg = `${person},%0AAaj aapki taraf se ₹${receivedAmount} receive hue.%0AShukriya.`;
                }
                
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
            }
        }

        // --- REPORTING ---
        function renderFullList() {
            const list = document.getElementById('full-list');
            list.innerHTML = '';
            const sorted = [...transactions].reverse();
            
            sorted.forEach(t => {
                let color = t.type === 'income' ? 'text-emerald-600' : (t.type === 'udhar' ? 'text-orange-500' : 'text-rose-600');
                let sign = t.type === 'income' ? '+' : '-';
                
                const li = document.createElement('li');
                li.className = "p-4 flex justify-between items-center hover:bg-slate-50";
                li.innerHTML = `
                    <div>
                        <div class="font-bold text-xs text-slate-700">${t.desc}</div>
                        <div class="text-[10px] text-slate-400">${t.date} • ${t.type.toUpperCase()}</div>
                    </div>
                    <div class="text-sm font-bold ${color}">${sign}${formatter.format(t.amount)}</div>
                `;
                list.appendChild(li);
            });
        }

        let chartInstance = null;
        function updateChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const legendContainer = document.getElementById('analysis-legend');
            const expenses = {};
            
            // Filter only expenses
            const expenseTx = transactions.filter(t => t.type === 'expense');
            const totalExpense = expenseTx.reduce((sum, t) => sum + t.amount, 0);

            // Group by category
            expenseTx.forEach(t => {
                expenses[t.desc] = (expenses[t.desc] || 0) + t.amount;
            });

            // Update Center Total
            document.getElementById('chart-total-center').innerText = formatter.format(totalExpense);

            // 1. Draw Chart
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenses),
                    datasets: [{
                        data: Object.values(expenses),
                        backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#64748b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%', // Thinner ring
                    plugins: { 
                        legend: { display: false }, // Hide default legend
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed;
                                    const pct = ((val/totalExpense)*100).toFixed(1);
                                    return ` ${context.label}: ${formatter.format(val)} (${pct}%)`;
                                }
                            }
                        }
                    } 
                }
            });

            // 2. Generate Custom Legend
            legendContainer.innerHTML = '';
            if (Object.keys(expenses).length === 0) {
                legendContainer.innerHTML = '<p class="text-center text-xs text-slate-400">No expenses recorded yet.</p>';
                return;
            }

            // Sort by amount
            const sortedCats = Object.entries(expenses).sort((a,b) => b[1] - a[1]);

            sortedCats.forEach(([cat, amount], index) => {
                const percent = ((amount / totalExpense) * 100).toFixed(1);
                const iconClass = categoryIcons[cat] || "fa-circle";
                const colors = ['bg-rose-500', 'bg-blue-500', 'bg-green-500', 'bg-amber-500', 'bg-violet-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-slate-500'];
                const color = colors[index % colors.length]; // Cycle colors to match chart roughly

                const html = `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 shadow-sm border border-slate-100">
                                <i class="fas ${iconClass} text-xs"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-xs">${cat}</p>
                                <div class="w-24 h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                    <div class="h-full ${color}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p>
                            <p class="text-[10px] text-slate-400 font-bold">${percent}%</p>
                        </div>
                    </div>
                `;
                legendContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- EXPORT/PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(13, 148, 136); // Teal Color
            doc.text("Madani Budget Report", 14, 20);
            
            // Subtitle with timestamp
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
            
            // Prepare Data
            const rows = transactions.slice().reverse().map(t => {
                // Extract Time from ID (timestamp)
                const dateObj = new Date(t.id);
                const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return [
                    { content: `${t.date}\n${timeStr}`, styles: { halign: 'center', valign: 'middle' } }, // Date & Time
                    t.desc,             // Category
                    t.note || '-',      // Details
                    t.type.toUpperCase(), // Type
                    t.account,          // Account
                    { content: formatter.format(t.amount).replace('₹', ''), styles: { halign: 'right', fontStyle: 'bold' } } // Amount
                ];
            });

            doc.autoTable({
                head: [['Date & Time', 'Category', 'Details', 'Type', 'Account', 'Amount']],
                body: rows,
                startY: 35,
                theme: 'grid',
                styles: { 
                    fontSize: 8, 
                    cellPadding: 3,
                    lineColor: [220, 220, 220],
                    lineWidth: 0.1,
                    textColor: 50
                },
                headStyles: { 
                    fillColor: [13, 148, 136], 
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Date Col
                    1: { cellWidth: 30, fontStyle: 'bold' }, // Category
                    2: { cellWidth: 'auto' }, // Details (takes remaining space)
                    3: { cellWidth: 20, halign: 'center' }, // Type
                    4: { cellWidth: 25, halign: 'center' }, // Account
                    5: { cellWidth: 25 }  // Amount
                },
                // Custom hook to make Time smaller (optional visual tweak via textColor if needed)
                didParseCell: function(data) {
                    if (data.column.index === 0 && data.section === 'body') {
                        // Just rely on newline for "neeche"
                    }
                }
            });
            doc.save('Madani_Budget_Report.pdf');
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(transactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");
            XLSX.writeFile(wb, "budget_data.xlsx");
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
            const a = document.createElement('a');
            a.href = dataStr; a.download = "backup.json"; a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                transactions = JSON.parse(e.target.result);
                saveData();
                alert("Data Restored!");
            };
            reader.readAsText(input.files[0]);
        }
        
        function clearAll() {
            if(confirm("Delete All Data?")) {
                transactions = [];
                saveData();
            }
        }
    </script>
</body>
</html>
